<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>로드뷰 보기</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #pano { width: 100%; height: 100%; }
        .back-btn {
            position: absolute; top: 10px; left: 10px; z-index: 100;
            background: white; padding: 8px 12px; border-radius: 4px;
            border: 1px solid #ccc; cursor: pointer; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId={{ client_id }}&submodules=panorama"></script>
</head>
<body>
    <div id="pano"></div>
    <button class="back-btn" onclick="window.close()">창 닫기</button>

    <script>
        // 1. URL에서 좌표 파싱
        const params = new URLSearchParams(window.location.search);
        const lat = parseFloat(params.get('lat'));
        const lng = parseFloat(params.get('lng'));
        const address = params.get('addr') || "위치";

        if (!lat || !lng) {
            alert("잘못된 좌표 정보입니다.");
            window.close();
        }

        const position = new naver.maps.LatLng(lat, lng);

        // 2. 파노라마 초기화
        const pano = new naver.maps.Panorama("pano", {
            position: position,
            pov: {
                pan: -135, // 초기값 (나중에 마커 쪽으로 자동 조정됨)
                tilt: 10,
                fov: 100
            },
            flightSpot: true // 항공 뷰 버튼 표시
        });

        // 3. 마커 생성 (파노라마 안에 표시될 마커)
        const marker = new naver.maps.Marker({
            position: position,
            map: pano, // ★ 중요: 일반 지도가 아니라 'pano' 객체에 붙임
            title: address,
            icon: {
                content: `
                    <div style="background: #ff0000; color: white; padding: 5px 10px; border-radius: 20px; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.5); font-weight: bold; font-size: 12px; white-space: nowrap;">
                        <i class="fa-solid fa-location-dot"></i> ${address}
                    </div>`
            }
        });

        // 4. 파노라마 로드 완료 시점 이벤트 (마커 바라보기 로직)
        // 출처: https://navermaps.github.io/maps.js.ncp/docs/tutorial-4-panorama-image-marker.example.html
        naver.maps.Event.addListener(pano, "init", function() {
            marker.setMap(pano); // 확실하게 파노라마에 부착

            // 마커가 있는 방향(POV) 계산
            const proj = pano.getProjection();
            const lookAtPov = proj.fromCoordToPov(marker.getPosition());
            
            // 카메라를 마커 쪽으로 회전
            if (lookAtPov) {
                pano.setPov(lookAtPov);
            } else {
                // 가끔 로드뷰 좌표와 마커 좌표가 너무 멀면 계산 안될 수 있음 -> 근처 파노라마로 이동 시도
                alert("해당 위치의 정확한 로드뷰를 찾을 수 없어 가장 가까운 곳을 보여줍니다.");
            }
        });

        // (옵션) 마커 클릭 시 이벤트
        naver.maps.Event.addListener(marker, "click", function(e) {
            alert("저장된 위치: " + address);
        });

    </script>
</body>
</html>